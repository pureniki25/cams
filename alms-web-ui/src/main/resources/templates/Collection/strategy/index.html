
<!DOCTYPE html>
<!--suppress ALL -->
<html lang="zh-cn">
<!--<html lang="en" xmlns:th="http://www.thymeleaf.org">-->
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

    <title >催收策略</title>
    <script src="/properties/config.js"></script>
    <link rel="stylesheet" type="text/css" href="/src/css/themes/default.css"/>
    <!-- iview样式 -->
    <link rel="stylesheet" type="text/css" href="/plugins/iview/css/iview.css"/>
    <!--@import url("//unpkg.com/iview/dist/styles/iview.css");-->
    <!--<link rel="stylesheet" type="text/css" href="//unpkg.com/iview/dist/styles/iview.css"/>-->
    <!-- 引入layui样式 -->
    <link rel="stylesheet" href="/plugins/layui/css/layui.css" media="all"/>

    <!--   <script src="//unpkg.com/vue/dist/vue.js"></script>
       <script src="//unpkg.com/iview/dist/iview.min.js"></script>-->
    <!-- 引入vue -->
    <script type="text/javascript" src="/plugins/vue/vue.min.js"></script>
    <!-- iview js -->
    <script type="text/javascript" src="/plugins/iview/js/iview.js"></script>
    <!--引入layui.js-->
    <script src="/plugins/layui/layui.js"></script>
    <!--引入axios.js 用于ajax调用-->
    <script src="/plugins/axios/axios.min.js"></script>
    <!-- 引入jQuery，必须在appToken.js 之前引入 -->
    <script src="/build/js/jquery-3.3.1.min.js"></script>
    <!-- 设置全局请求头:app、Authorization -->
    <script src="/build/js/appToken.js"></script>
    <!--引入公共的一些方法-->
    <script src="/src/js/comm.js"></script>

</head>
<body>
<!--隐藏元素-->
<!--<p id="staffType"  th:attr="value=${staffType}"  hidden />-->
<!--使用v-cloak技术，在vue渲染完毕前隐藏页面，渲染完成后显示-->
<div id="app" v-cloak>
    <tabs value="personSetter">
        <tab-pane label="催收人员设置" name="personSetter">

            <!--查询表单内容-->
            <row :gutter="16">
                <i-col span="3">
                    <i-button type="success" style="margin-left:15px" @click="assignSet"  ht-auth="assignSet">分配设置</i-button>
                </i-col>
                <i-col  span="16">
                <i-form ref="searchForm"  :model="searchForm"    label-position="right" :label-width="100" inline>

                        <form-item label="区域：" prop="areaId">
                            <i-select v-model="searchForm.areaId" clearable  filterable >
                                <i-option v-for="item in areaList" :value="item.areaId" :key="item.areaId" >{{ item.areaName }}</i-option>
                            </i-select>
                        </form-item>


                        <form-item label="分公司：" prop="companyId">
                            <i-select v-model="searchForm.companyId" clearable filterable >
                                <i-option v-for="item in companyList" :value="item.areaId" :key="item.areaId">{{ item.areaName }}</i-option>
                            </i-select>
                        </form-item>



                        <form-item label="人员：" prop="userName">
                            <i-input v-model="searchForm.userName" ></i-input>
                        </form-item>

                </i-form>
                </i-col>
                <i-col span="5">
                    <i-button type="info" :loading="loading" icon="ios-search" @click="toLoading" style="margin-right:10px" ht-auth="personQuery">
                        <span v-if="!loading">查询</span>
                        <span v-else>查询中...</span>
                    </i-button>
                </i-col>

            </row>

            <!-- 表单Grid，使用layerUI的表格组件 开始 -->
            <row style="padding: 10px">
                <i-col span="24">
                    <!-- 使用方法渲染模式 -->
                    <table id="listTable" lay-filter="listTable"></table>
                    <div style="display:none" id="barTools">
                        <!--layui-btn layui-btn-xs-->
                        <i-button style="width:80px" type="success" lay-event="userSet" ht-auth="singleSet" >设置</i-button>
                    </div>
                </i-col>
            </row>
            <!-- 表单Grid，使用layerUI的表格组件 结束 -->

            <Modal
                    v-model="editSingleCompanyCollectionUserSettingModal"
                    title="设置"
                    @on-ok="saveSingleCompanyCollectionUserSetting"
                    @on-cancel="toLoading">
                <i-form ref="editCompanyCollectionUser.editCompanyCollectionForm" :model="editCompanyCollectionUser.editCompanyCollectionForm"  :label-width="80">
                    <form-item label="清算1：" prop="collectionGroup1Users">
                        <i-select v-model="editCompanyCollectionUser.editCompanyCollectionForm.collectionGroup1Users" multiple clearable filterable >
                            <i-option v-for="item in editCompanyCollectionUser.collectionGroup1AllUsers" :value="item.userId" :key="item.userId">{{ item.userName }}</i-option>
                        </i-select>
                    </form-item>

                    <form-item label="清算2："  prop="collectionGroup2Users">
                        <i-select v-model="editCompanyCollectionUser.editCompanyCollectionForm.collectionGroup2Users" multiple clearable filterable >
                            <i-option v-for="item in editCompanyCollectionUser.collectionGroup2AllUsers" :value="item.userId" :key="item.userId">{{ item.userName }}</i-option>
                        </i-select>
                    </form-item>

                </i-form>
            </Modal>

            <!--
                    时间设置标签页

            -->

            <Modal
                    v-model="editSingleCompanyCollectionTimeSettingModal"
                    title="设置"
                    @on-ok="saveTimeSet"
                    @on-cancel="toLoadingTime">
                <i-form ref="editCompanyCollectionTime.editCompanyCollectionForm" :model="editCompanyCollectionTime.editCompanyCollectionForm"  :label-width="80">
                    <form-item label="逾期天数：" prop="collectionOverDueDays" :rules="{required:true}">
                        <i-input v-model="editCompanyCollectionTime.editCompanyCollectionForm.overDueDays" maxlength="10" style="width: 200px"></i-input>
                    </form-item>

                    <form-item label="开始时间："  prop="collectionStartTime" :rules="{required:true}">
                        <!--<i-input v-model="editCompanyCollectionTime.editCompanyCollectionForm.startTime" type="date"></i-input>-->

                        <date-picker type="date" :options="options3" placeholder="Select date" style="width: 200px" v-model="editCompanyCollectionTime.editCompanyCollectionForm.startTime"></date-picker>

                    </form-item>

                    <form-item label="备注："  prop="collectionNote">
                        <i-input v-model="editCompanyCollectionTime.editCompanyCollectionForm.note" type="textarea" :rows="4" placeholder="Enter something..."></i-input>
                    </form-item>

                    <form-item label="序号："  prop="colTimeId" style="display: none">
                        <i-input v-model="editCompanyCollectionTime.editCompanyCollectionForm.colTimeId" ></i-input>
                    </form-item>

                </i-form>
            </Modal>

            <!--
                分配设置
            -->
            <Modal
                    v-model="assignSetModal"
                    title="设置"
                    @on-ok="saveBatchPerson"
                    @on-cancel="toLoading">
                <i-form ref="editCompanyCollectionAssignSet.editCompanyCollectionForm" :model="editCompanyCollectionAssignSet.editCompanyCollectionForm"  :label-width="80">
                    <form-item label="区域：" prop="areaName">
                        <i-select v-model="editCompanyCollectionAssignSet.editCompanyCollectionForm.areaName" multiple clearable filterable >
                            <i-option v-for="item in editCompanyCollectionAssignSet.areaList" :value="item.areaId" :key="item.areaId">{{ item.areaName }}</i-option>
                        </i-select>
                        <!--<i-span @click="selectArea">选择</i-span>-->
                    </form-item>

                    <form-item label="分公司："  prop="companyName">
                        <i-select v-model="editCompanyCollectionAssignSet.editCompanyCollectionForm.companyId" multiple clearable filterable >
                            <i-option v-for="item in editCompanyCollectionAssignSet.companyId" :value="item.areaId" :key="item.areaId">{{ item.areaName }}</i-option>
                        </i-select>
                    </form-item>

                    <form-item label="清算1：" prop="collectionGroup1Users">
                        <i-select v-model="editCompanyCollectionAssignSet.editCompanyCollectionForm.collectionGroup1Users" multiple clearable filterable  style="width: 80%">
                            <i-option v-for="item in editCompanyCollectionAssignSet.collectionGroup1AllUsers" :value="item.userId" :key="item.userId">{{ item.userName }}</i-option>
                        </i-select>
                    </form-item>

                    <form-item label="清算2："  prop="collectionGroup2Users">
                        <i-select v-model="editCompanyCollectionAssignSet.editCompanyCollectionForm.collectionGroup2Users" multiple clearable filterable style="width: 80%" >
                            <i-option v-for="item in editCompanyCollectionAssignSet.collectionGroup2AllUsers" :value="item.userId" :key="item.userId">{{ item.userName }}</i-option>
                        </i-select>
                    </form-item>

                </i-form>
            </Modal>

        </tab-pane>




        <tab-pane label="催收时间设置" name="timeSetter">
            <row style="padding: 10px">
                <i-col span="24">
                    <!-- 使用方法渲染模式 -->
                    <table id="timeListTable" lay-filter="timeListTable"></table>
                    <div style="display:none" id="timeListBarTools">
                        <!--layui-btn layui-btn-xs-->
                        <i-button style="width:80px" type="success" lay-event="timeSet" ht-auth="timeSingleSet" >设置</i-button>
                    </div>
                </i-col>
            </row>

        </tab-pane>
    </tabs>


</div>






<script>

    window.layinit(function (htConfig) {
        var _htConfig = htConfig;
        basePath = _htConfig.coreBasePath;
        var vm = new Vue({
            el: '#app',
            data: {
                options3:{
                    disabledDate (date) {
                        return date && date.valueOf() < Date.now() - 86400000;
                    }
                },
                searchForm:
                    {
                        areaId: '',
                        companyId: '',
                        userName: '',

                    },
                loading: false,
                areaList: [],
                companyList: [],
                selectedRowInfo: [],
                editSingleCompanyCollectionUserSettingModal: false,
                editSingleCompanyCollectionTimeSettingModal: false,
                assignSetModal:false,
                editCompanyCollectionUser:
                   {
                       editCompanyCollectionForm:
                           {
                               collectionGroup1Users: [],
                               collectionGroup2Users: [],
                               companyId: [],
                               areaId:''
                           },
                       collectionGroup1AllUsers: [],
                       collectionGroup2AllUsers: []
                   },
                editCompanyCollectionTime:
                   {
                       editCompanyCollectionForm:
                           {
                               overDueDays:'',
                               startTime:'',
                               note:'',
                               colTimeId:''
                           }
                   },
                editCompanyCollectionAssignSet:
                    {
                        editCompanyCollectionForm:
                            {
                                areaName:[],
                                companyId:[],
                                collectionGroup1Users:[],
                                collectionGroup2Users:[]
                            },
                        collectionGroup1AllUsers: [],
                        collectionGroup2AllUsers: [],
                        areaList: [],
                        companyId: []
                    }

            },
            computed: {},
            methods: {
                init: function () {
                    var self = this;
                    self.getCompanyAreaList();
                    self.getCompanyList();
                    //使用layerUI的表格组件
                    layui.use(['layer', 'table', 'ht_ajax', 'ht_auth', 'ht_config'], function () {
                        layer = layui.layer;
                        table = layui.table;
                        //执行渲染
                        table.render({
                            elem: '#listTable' //指定原始表格元素选择器（推荐id选择器）
                            , id: 'listTable'

                            , cols: [[
                                {
                                    field: 'companyId',
                                    title: '分公司Id',
                                    align:'center',
                                },

                                {
                                    field: 'areaName',
                                    title: '区域',
                                    align:'center'
                                }, {
                                    field: 'companyName',
                                    title: '分公司',
                                    align:'center'
                                }, {
                                    field: 'collect1Person',
                                    title: '清算一',
                                    align:'center'
                                }, {
                                    field: 'collect2Person',
                                    title: '清算二',
                                    align:'center'
                                }, {
                                    fixed: 'right',
                                    title: '操作',
                                    width: 100,
                                    align: 'center',
                                    toolbar: '#barTools'
                                }

                            ]], //设置表头
                            url: basePath + 'collectionStrategy/getCollectionUserSettingList',

                            page: true,
                            done: function (res, curr, count) {
                                //数据渲染完的回调。你可以借此做一些其它的操作
                                //如果是异步请求数据方式，res即为你接口返回的信息。
                                //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
                                self.loading = false;
                            }
                        });

                        ///////////////////////////////////////////////////////////////////////////
                        //   时间设置页面参数
                        ///////////////////////////////////////////////////////////////////////////


                        table.render({
                            elem: '#timeListTable' //指定原始表格元素选择器（推荐id选择器）
                            , id: 'timeListTable'

                            , cols: [[
                                {
                                    field: 'colTimeId',
                                    title: '序号',
                                    align:'center',
                                },

                                {
                                    field: 'colType',
                                    title: '移交类型',
                                    align:'center'
                                }, {
                                    field: 'overDueDays',
                                    title: '逾期天数',
                                    align:'center'
                                }, {
                                    field: 'startTime',
                                    title: '开始执行时间',
                                    align:'center',

                                }, {
                                    fixed: 'right',
                                    title: '操作',
                                    width: 100,
                                    align: 'center',
                                    toolbar: '#timeListBarTools'
                                }

                            ]], //设置表头
                            url: basePath + 'collectionStrategy/getCollectionTimeSettingList',

                            page: true,
                            done: function (res, curr, count) {
                                //数据渲染完的回调。你可以借此做一些其它的操作
                                //如果是异步请求数据方式，res即为你接口返回的信息。
                                //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
                                self.loading = false;
                            }
                        });



                        //监听工具条
                        table.on('tool(listTable)', function (obj) {
                            self.selectedRowInfo = obj.data;
                            if (obj.event === 'edit') {
                                showSingleCompanyCollectionUserSetting(companyCode)

                            }
                            if(obj.event === 'userSet'){
                                console.log(JSON.stringify(obj.data));
                                self.editSingleCompanyCollectionUserSettingModal = true;
                                var url = basePath + "collectionStrategy/company/getClearingPersons";
                                axios.get(url)
                                    .then(function (result) {
                                        if (result.data.code == "1") {
                                            console.log(result.data.data.sysUser);
                                            self.editCompanyCollectionUser.collectionGroup1AllUsers = result.data.data.sysUser;
                                            self.editCompanyCollectionUser.collectionGroup2AllUsers = result.data.data.sysUser;
                                            self.editCompanyCollectionUser.editCompanyCollectionForm.areaId = obj.data.areaId;
                                            self.editCompanyCollectionUser.editCompanyCollectionForm.companyId[0] = obj.data.companyId;
                                        }
                                    })
                            }
                        });

                        ////////////////////////////////////////////////////////////////////////////////////

                        ///////////////////////////////////////////////////////////////////////////////////

                        //监听工具条
                        table.on('tool(timeListTable)', function (obj) {
                            self.selectedRowInfo = obj.data;
                            if (obj.event === 'timeSet') {
                                console.log("succes===========>>>>>>>>>>>>");
                                self.editSingleCompanyCollectionTimeSettingModal = true;
                                console.log(JSON.stringify(obj.data))
                                self.editCompanyCollectionTime.editCompanyCollectionForm.colTimeId = obj.data.colTimeId;
                            }
                        });

                    });

                },
                toLoading: function () {
                    if (table == null) {
                        return;
                    }
                    var self = this;
                    self.loading = true;
                    table.reload('listTable', {
                        where: {

                            areaId: self.searchForm.areaId,  //区域ID
                            companyId: self.searchForm.companyId, //分公司ID
                            userName: self.searchForm.userName,  //业务类型
                        }
                        , page: {
                            curr: 1 //重新从第 1 页开始
                        }
                    });
                },
                toLoadingTime: function () {
                    if (table == null) {
                        return;
                    }
                    var self = this;
                    self.loading = true;
                    table.reload('timeListTable');
                },
                getCompanyAreaList: function () {
                    var self = this;
                    var url = basePath + "collectionStrategy/company/getCompanyAreaList?id=1";
                    axios.get(url)
                        .then(function (result) {
                            if (result.data.code == "1") {
                                self.areaList = result.data.data.area;
                            }
                        })
                },
                getCompanyList:function () {
                    var self = this;
                    var url = basePath + "collectionStrategy/company/getCompanyAreaList?id=2";
                    axios.get(url)
                        .then(function (result) {
                            if (result.data.code == "1") {
                                self.companyList = result.data.data.area;
                            }
                        })
                },
                getCollectionGroup1AllUsers: function () {
                    if (this.editCompanyCollectionUser.collectionGroup1AllUsers.length > 0) {
                        return;
                    }

                    var url = basePath + "users/getUsers";
                    axios.get(url)
                        .then(function (result) {
                            if (result.data.code == "1") {
                                self.collectionGroup1AllUsers = result.data.data;
                            }
                        })

                },
                getCollectionGroup2AllUsers: function () {
                    if (this.editCompanyCollectionUser.collectionGroup2AllUsers.length > 0) {
                        return;
                    }
                    var url = basePath + "users/getUsers";

                    axios.get(url)
                        .then(function (result) {
                            if (result.data.code == "1") {
                                self.collectionGroup2AllUsers = result.data.data;
                            }
                        })
                },
                saveSingleCompanyCollectionUserSetting:function()
                {
                    var self=this;
                    var url = basePath + "collectionStrategy/saveSingleCompanyCollectionUserSetting";
                    console.log("=============================");
                    console.log(JSON.stringify(self.editCompanyCollectionUser.editCompanyCollectionForm));
                    console.log("=============================");
                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(self.editCompanyCollectionUser.editCompanyCollectionForm),
                        async: false,
                        dataType: "json",
                        success: function (data) {
                            self.toLoading();
                        }

                    });
                },
                saveTimeSet:function () {
                    var self=this;
                    var url = basePath + "collectionStrategy/saveTimeSet";
                    console.log("=============================");
                    console.log(JSON.stringify(self.editCompanyCollectionTime.editCompanyCollectionForm));
                    console.log("=============================");
                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(self.editCompanyCollectionTime.editCompanyCollectionForm),
                        async: false,
                        dataType: "json",
                        success: function (data) {
                            self.toLoadingTime();
                        }

                    });
                },
                showSingleCompanyCollectionUserSetting:function(companyId)
                {
                    this.editCompanyCollectionUser.editCompanyCollectionForm.companyId=companyId;
                    this.getCollectionGroup1AllUsers();
                    this.getCollectionGroup2AllUsers();
                    var url = basePath + "collectionStrategy/getSingleCompanyCollectionUserSetting";

                    axios.get(url)
                        .then(function (result) {
                            if (result.data.code == "1") {
                                self.collectionGroup2AllUsers = result.data.data;
                            }
                        })
                    this.editSingleCompanyCollectionUserSettingModal=true;

                },
                assignSet:function () {
                    var self = this;
                    self.assignSetModal = true;
                    var url = basePath + "collectionStrategy/company/getClearingPersons";
                    axios.get(url)
                        .then(function (result) {
                            if (result.data.code == "1") {
                                console.log(result.data.data.sysUser);
                                self.editCompanyCollectionAssignSet.collectionGroup1AllUsers = result.data.data.sysUser;
                                self.editCompanyCollectionAssignSet.collectionGroup2AllUsers = result.data.data.sysUser;
                                self.editCompanyCollectionAssignSet.areaList = result.data.data.areaList;
                                self.editCompanyCollectionAssignSet.companyId = result.data.data.companyList;
                            }
                        })
                },
                selectArea:function () {

                    layui.use(['layer', 'table', 'ht_ajax', 'ht_auth', 'ht_config'], function () {
                        //弹出流程配置
                        showLitigationSettle = function () {
                            var url = "../page/doc/test.html";
                            var openIndex = layer.open({
                                type: 2,
                                area: ['90%', '90%'],
                                full: true,
                                fixed: false,
                                maxmin: true,
                                title: '选择分公司',
                                content: url,
                                //btn: ['保存', '取消'],
                                yes: function (index, layero) {

                                }
                            });
                        };
                    })
                    showLitigationSettle();
                    console.log("===================.》》》》》》》》》》》》》》》》》》》》》》");
                },
                saveBatchPerson:function () {
                    var self = this;
                    var url = basePath + "collectionStrategy/saveSingleCompanyCollectionUserSetting";
                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(self.editCompanyCollectionAssignSet.editCompanyCollectionForm),
                        async: false,
                        dataType: "json",
                        success: function (data) {
                            self.toLoading();
                        }

                    });
                }


            },
            mounted: function () {
                this.init();
            }

        })
    });
</script>
</body>
</html>