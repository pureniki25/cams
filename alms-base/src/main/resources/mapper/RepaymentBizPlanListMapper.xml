<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hongte.alms.base.mapper.RepaymentBizPlanListMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.hongte.alms.base.entity.RepaymentBizPlanList">
        <id column="plan_list_id" property="planListId" />
        <result column="plan_id" property="planId" />
        <result column="business_id" property="businessId" />
        <result column="orig_business_id" property="origBusinessId" />
        <result column="period" property="period" />
        <result column="after_id" property="afterId" />
        <result column="due_date" property="dueDate" />
        <result column="total_borrow_amount" property="totalBorrowAmount" />
        <result column="overdue_amount" property="overdueAmount" />
        <result column="derate_amount" property="derateAmount" />
        <result column="overdue_days" property="overdueDays" />
        <result column="current_status" property="currentStatus" />
        <result column="current_sub_status" property="currentSubStatus" />
        <result column="repay_status" property="repayStatus" />
        <result column="repay_flag" property="repayFlag" />
        <result column="fact_repay_date" property="factRepayDate" />
        <result column="finance_comfirm_date" property="financeComfirmDate" />
        <result column="finance_confirm_user" property="financeConfirmUser" />
        <result column="finance_confirm_user_name" property="financeConfirmUserName" />
        <result column="confirm_flag" property="confirmFlag" />
        <result column="auto_withholding_confirmed_date" property="autoWithholdingConfirmedDate" />
        <result column="auto_withholding_confirmed_user" property="autoWithholdingConfirmedUser" />
        <result column="auto_withholding_confirmed_user_name" property="autoWithholdingConfirmedUserName" />
        <result column="accountant_confirm_status" property="accountantConfirmStatus" />
        <result column="accountant_confirm_user" property="accountantConfirmUser" />
        <result column="accountant_confirm_user_name" property="accountantConfirmUserName" />
        <result column="accountant_confirm_date" property="accountantConfirmDate" />
        <result column="remark" property="remark" />
        <result column="create_time" property="createTime" />
        <result column="src_type" property="srcType" />
        <result column="create_user" property="createUser" />
        <result column="update_time" property="updateTime" />
        <result column="update_user" property="updateUser" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        plan_list_id AS planListId, plan_id AS planId, business_id AS businessId, orig_business_id AS origBusinessId, period, after_id AS afterId, due_date AS dueDate, total_borrow_amount AS totalBorrowAmount,derate_amount as derateAmount, overdue_amount AS overdueAmount, overdue_days AS overdueDays, current_status AS currentStatus, current_sub_status AS currentSubStatus,repay_status as repayStatus, repay_flag AS repayFlag, fact_repay_date AS factRepayDate, finance_comfirm_date AS financeComfirmDate, finance_confirm_user AS financeConfirmUser, finance_confirm_user_name AS financeConfirmUserName, confirm_flag AS confirmFlag, auto_withholding_confirmed_date AS autoWithholdingConfirmedDate, auto_withholding_confirmed_user AS autoWithholdingConfirmedUser, auto_withholding_confirmed_user_name AS autoWithholdingConfirmedUserName, accountant_confirm_status AS accountantConfirmStatus, accountant_confirm_user AS accountantConfirmUser, accountant_confirm_user_name AS accountantConfirmUserName, accountant_confirm_date AS accountantConfirmDate, remark,  create_time AS createTime, src_type AS srcType, create_user AS createUser, update_time AS updateTime, update_user AS updateUser
    </sql>

    <!-- 通用查询结果列 -->
    <sql id="TableName_Column_List">
        planList.plan_list_id AS planListId, planList.plan_id AS planId, planList.business_id AS businessId, planList.orig_business_id AS origBusinessId,planList.period as period, planList.after_id AS afterId, planList.due_date AS dueDate, planList.total_borrow_amount AS totalBorrowAmount, planList.overdue_amount AS overdueAmount, planList.overdue_days AS overdueDays, planList.current_status AS currentStatus, planList.repay_flag AS repayFlag, planList.fact_repay_date AS factRepayDate, planList.finance_comfirm_date AS financeComfirmDate, planList.finance_confirm_user AS financeConfirmUser, planList.finance_confirm_user_name AS financeConfirmUserName, planList.confirm_flag AS confirmFlag, planList.auto_withholding_confirmed_date AS autoWithholdingConfirmedDate, planList.auto_withholding_confirmed_user AS autoWithholdingConfirmedUser, planList.accountant_confirm_status AS accountantConfirmStatus, planList.accountant_confirm_user AS accountantConfirmUser, planList.accountant_confirm_user_name AS accountantConfirmUserName, planList.accountant_confirm_date AS accountantConfirmDate, planList.remark AS  remark, planList.create_time AS createTime, planList.create_user AS createUser, planList.update_time AS updateTime, planList.update_user AS updateUser
    </sql>

    <!-- 选择需要 自动移交的一般业务还款计划列表(包括展期业务) -->
    <select id="selectNeedSetColInfoNormalBizPlansBycomId"
            resultType="com.hongte.alms.base.entity.RepaymentBizPlanList">
        SELECT
        <include refid="TableName_Column_List"/>

        FROM tb_repayment_biz_plan_list planList
        LEFT JOIN tb_repayment_biz_plan plan ON plan.plan_id = planList.plan_id
        LEFT JOIN tb_basic_business business ON plan.original_business_id = business.business_id
        LEFT JOIN tb_basic_business_type type on type.business_type_id=business.business_type

        WHERE
        <![CDATA[ TO_DAYS(NOW()) - TO_DAYS(planList.due_date) >=#{overDueDays}  ]]>
        <if test = "companyId != null and companyId!='' ">
            and business.company_id = #{companyId}
        </if>
        
         <if test = "businessType != null and businessType!='' and businessType!=0">
            and type.business_type_id = #{businessType}
        </if>
		<if test = "businessId != null and businessId!=''">
			and planList.business_id = #{businessId}
		</if>

        AND planList.current_status IN ("还款中","逾期")
        AND (
        SELECT COUNT(1) as num1  FROM tb_collection_status  cStatus
		WHERE
		<choose>
			<!-- 电催的业务  催收的业务 -->
			<when test="colStatus !=null  and (colStatus =1 or colStatus =50)">
				cStatus.collection_status  in (100, 200,150)
			</when>
			<!-- 诉讼的业务 -->
			<when test="colStatus !=null  and colStatus =100">
				cStatus.collection_status  in (100, 200)
			</when>
		</choose>
        AND cStatus.collection_status  in (100, 200,150)
        AND cStatus.business_id = business.business_id
        ) = 0
        AND (
        SELECT COUNT(1) as num2  FROM tb_collection_status  cStatus
		WHERE
		<choose>
			<!-- 电催的业务 -->
			<when test="colStatus !=null  and colStatus =1">
				 cStatus.phone_staff is NULL
			</when>
			<!-- 催收的业务 -->
			<when test="colStatus !=null  and colStatus =50">
				 cStatus.visit_staff is NULL
			</when>
			<!-- 诉讼的业务 -->
		</choose>
        AND cStatus.business_id = business.business_id
        AND cStatus.crp_id = planList.plan_list_id
        ) = 0 order by planList.period;


    </select>
    
    <select id="queryRepaymentBizPlanListByConditions" resultType="java.lang.String">
   		SELECT b.plan_list_id 
   		  FROM `tb_repayment_biz_plan` a, `tb_repayment_biz_plan_list` b
		WHERE a.`plan_id` = b.`plan_id`
		  AND a.`original_business_id` = #{businessId,jdbcType=VARCHAR}
		  AND b.`after_id` = #{afterId,jdbcType=VARCHAR}
    </select>
    <!--AND cStatus.crp_id = planList.plan_list_id  -->

   <!-- &lt;!&ndash; 需要自动移交的展期业务的还款计划 &ndash;&gt;
    <select id="selectNeedSetColInfoRenewBizPlansBycomId" resultType="com.hongte.alms.base.entity.RepaymentBizPlanList">

    SELECT <include refid="TableName_Column_List"/>

    FROM tb_repayment_biz_plan_list planList
    LEFT JOIN tb_repayment_biz_plan plan ON plan.plan_id = planList.plan_id
    LEFT JOIN tb_renewal_business rewBiz ON plan.business_id = rewBiz.renewal_business_id
    LEFT JOIN tb_basic_business business ON rewBiz.original_business_id = business.business_id


    WHERE
    <![CDATA[ TO_DAYS(NOW()) - TO_DAYS(planList.due_date) > #{overDueDays}  ]]>
        <if test = "companyId != null and companyId!='' ">
            and business.company_id = #{companyId}
        </if>
    AND planList.current_status IN ("还款中","逾期")
    AND (
        SELECT COUNT(1) as num  FROM tb_collection_status  cStatus
        WHERE cStatus.collection_status =100
        AND cStatus.business_id = rewBiz.renewal_business_id
        ) = 0
    AND (
        SELECT COUNT(1) as num  FROM tb_collection_status  cStatus
        WHERE cStatus.collection_status = #{colStatus}
        AND cStatus.business_id = rewBiz.renewal_business_id
        AND cStatus.crp_id = planList.plan_list_id
        ) = 0

    </select>-->
    <!-- AND cStatus.crp_id = planList.plan_list_id -->

    <select id="conutFinanceManagerListBak" resultType="int"
		parameterType="com.hongte.alms.base.dto.FinanceManagerListReq">
		SELECT
			count(distinct pl.plan_list_id)
		FROM
		tb_repayment_biz_plan_list pl
		JOIN tb_basic_business b ON b.business_id = pl.orig_business_id
		LEFT JOIN tb_basic_company bc ON bc.area_id = b.company_id
		LEFT JOIN tb_money_pool_repayment mpr ON mpr.plan_list_id = pl.plan_list_id 
		<where>
			1 = 1
			 and b.business_id in (select business_id from tb_sys_user_permission where user_id = #{userId} ) 
			<if test="customer != null">
				<!-- AND b.customer_name = #{customer} -->
				AND b.customer_name like '${customer}%' 
			</if>
			<if test="businessId != null">
				AND pl.orig_business_id like  '${businessId}%'
			</if>
			<if test="accountantConfirmStatus != null">
				AND pl.accountant_confirm_status =
				#{accountantConfirmStatus}
			</if>
			<if test="areaId != null">
				AND bc.area_pid = #{areaId}
			</if>
			<if test="companyId != null">
				AND b.company_name = #{companyId}
			</if>
			<if test="businessType != null ">
				AND b.business_type = #{businessType}
			</if>
			<if test="repayDate != null">
				AND DATE_FORMAT(pl.due_date,'%Y-%m-%d') = #{repayDate}
			</if>
			<if test="regDateStart != null ">
				AND mpr.trade_date &gt;= #{regDateStart}
			</if>
			<if test="regDateEnd != null ">
				AND mpr.trade_date &lt;= #{regDateEnd}
			</if>
			<if test="status != null ">
				AND pl.current_status = #{status}
			</if>
		</where>
	</select>
	
	<select id="conutFinanceManagerList" resultType="int"
		parameterType="com.hongte.alms.base.dto.FinanceManagerListReq">
		SELECT
			count(distinct pl.plan_list_id)
		FROM
			tb_repayment_biz_plan_list_synch pl
		<if test="paymentPlatformCode!=null">
	        JOIN tb_tuandai_project_info as ttpi ON pl.business_id = ttpi.business_id
	        and ttpi.plate_type = #{paymentPlatformCode,jdbcType=INTEGER}
        </if>	
		<where>
			1 = 1
			<if test="userId !=null  and userId != '' and needPermission == 1">
                and pl.orig_business_id in (
					select business_id from tb_sys_user_permission where page_type = 9 and user_id = #{userId}    	
                )
            </if>
			<if test="customer != null">
				<!-- AND b.customer_name = #{customer} -->
				AND pl.customer_name_ext like '${customer}%' 
			</if>
			<if test="businessId != null">
				AND pl.orig_business_id like  '${businessId}%'
			</if>
			<if test="accountantConfirmStatus != null">
				AND pl.accountant_confirm_status =
				#{accountantConfirmStatus}
			</if>
			<if test="areaId != null">
				AND pl.area_pid_ext = #{areaId}
			</if>
			<if test="companyId != null">
				AND pl.company_id_ext = #{companyId}
			</if>
			<if test="businessType != null ">
				AND pl.business_type_ext = #{businessType}
			</if>
			<if test="repayDate != null">
				AND DATE_FORMAT(pl.due_date,'%Y-%m-%d') = #{repayDate}
			</if>
			<if test="regDateStart != null ">
				AND pl.trade_date_ext &gt;= #{regDateStart}
			</if>
			<if test="regDateEnd != null ">
				AND pl.trade_date_ext &lt;= #{regDateEnd}
			</if>
			<if test="status != null ">
				AND pl.current_status = #{status}
			</if>
		</where>

	</select>

	<select id="selectFinanceMangeList_bak"
		resultType="com.hongte.alms.base.vo.module.FinanceManagerListVO"
		parameterType="com.hongte.alms.base.dto.FinanceManagerListReq">
		SELECT
			distinct 
			pl.plan_id as planId,
			pl.confirm_flag as confirmFlag,
			pl.plan_list_id as planListId,
			pl.business_id as businessId,
			pl.orig_business_id as orgBusinessId,
			pl.period as period,
			pl.after_id as afterId ,
			b.company_id as dept,
			b.operator_name as operator,
			b.customer_name as customer,
			b.business_ctype as businessType ,
			pl.due_date as planRepayDate ,
			b.borrow_money as borrowMoney,
			bbc.phone_number phoneNumber,
			CASE
			    repayment_type_id 
			    WHEN 1 
			    THEN '先息后本' 
			    WHEN 2
			    THEN '先息后本' 
			    WHEN 4
			    THEN '等本等息'
			    WHEN 5
			    THEN '等额本息'
			    WHEN 9
			    THEN '分期还本付息'
			    ELSE ''
		    END as repaymentType,
		    b.borrow_limit borrowLimit,
			pl.fact_repay_date as factRepayDate,
			CASE
			WHEN isnull(pl.overdue_amount) THEN  pl.total_borrow_amount
			ELSE (pl.total_borrow_amount+pl.overdue_amount   )  END as planRepayAmount,
			pl.current_status as status ,
			CASE
				when (pl.src_type = 1) then pl.current_status
				when (pl.src_type = 2 and pl.repay_status = 1) then '部分还款'
				when (pl.src_type = 2 and pl.repay_status = 2) then '线上已还款'
				when (pl.src_type = 2 and pl.repay_status = 3) then '全部已还款'
				when (pl.src_type = 2 and pl.repay_status is null ) then '未还款'
			END AS repayStatus,
			pl.accountant_confirm_status as financeConfirmStatus,
			(SELECT IFNULL(SUM(fact_amount),0) FROM tb_repayment_biz_plan_list_detail where plan_list_id = pl.plan_list_id ) as repaidAmount,
			b.src_type as srcType
		FROM
		tb_repayment_biz_plan_list pl
		JOIN tb_basic_business b ON b.business_id = pl.orig_business_id
		LEFT JOIN tb_basic_biz_customer bbc ON b.business_id = bbc.business_id and bbc.ismain_customer = 1
		LEFT JOIN tb_basic_company bc ON bc.area_id = b.company_id
		LEFT JOIN tb_money_pool_repayment mpr ON mpr.plan_list_id = pl.plan_list_id 

		<where>
			1 = 1
			<if test="userId !=null  and userId != '' and needPermission == 1">
                and pl.orig_business_id in (
					select business_id from tb_sys_user_permission where page_type = 9 and user_id = #{userId}    	
                )
            </if>
			<if test="customer != null">
				<!-- AND b.customer_name = #{customer} -->
				AND b.customer_name like '${customer}%' 
			</if>
			<if test="businessId != null">
				AND pl.orig_business_id like  '${businessId}%'
			</if>
			<if test="accountantConfirmStatus != null">
				AND pl.accountant_confirm_status =
				#{accountantConfirmStatus}
			</if>
			<if test="areaId != null">
				AND bc.area_pid = #{areaId}
			</if>
			<if test="companyId != null">
				AND b.company_name = #{companyId}
			</if>
			<if test="businessType != null ">
				AND b.business_type = #{businessType}
			</if>
			<if test="repayDate != null">
				AND DATE_FORMAT(pl.due_date,'%Y-%m-%d') = #{repayDate}
			</if>
			<if test="regDateStart != null ">
				AND mpr.trade_date &gt;= #{regDateStart}
			</if>
			<if test="regDateEnd != null ">
				AND mpr.trade_date &lt;= #{regDateEnd}
			</if>
			<if test="status != null ">
				AND pl.current_status = #{status}
			</if>
		</where>
		order by pl.due_date
		limit ${(curPage-1)*pageSize} , ${pageSize}
	</select>
	
	
	<select id="selectFinanceMangeList"
		resultType="com.hongte.alms.base.vo.module.FinanceManagerListVO"
		parameterType="com.hongte.alms.base.dto.FinanceManagerListReq">
			SELECT DISTINCT pl.plan_id AS planId, pl.confirm_flag AS confirmFlag, pl.plan_list_id AS planListId, pl.business_id AS businessId, pl.orig_business_id AS orgBusinessId
				, pl.period AS period, pl.after_id AS afterId, 
				pl.company_name_ext AS dept, 
				pl.operator_name_ext AS operator, 
				pl.customer_name_ext AS customer
				, pl.phone_number_ext AS phoneNumber, pl.business_ctype_ext AS businessType, pl.due_date AS planRepayDate, pl.borrow_money_ext AS borrowMoney
				, (SELECT tpi.plate_type 
			  FROM
			    `tb_tuandai_project_info` tpi 
			  WHERE tpi.business_id = pl.business_id 
			  LIMIT 1) plateType,
			  CASE repayment_type_id_ext
					WHEN 1 THEN '先息后本'
					WHEN 2 THEN '先息后本'
					WHEN 4 THEN '等本等息'
					WHEN 5 THEN '等额本息'
					WHEN 9 THEN '分期还本付息'
					ELSE ''
				END AS repaymentType, pl.borrow_limit_ext AS borrowLimit, pl.fact_repay_date AS factRepayDate
				, CASE 
					WHEN ISNULL(pl.overdue_amount) THEN pl.total_borrow_amount
					ELSE pl.total_borrow_amount + pl.overdue_amount
				END AS planRepayAmount, pl.current_status AS STATUS
				, CASE
				when (pl.src_type = 1) then pl.current_status
				when (pl.src_type = 2 and pl.repay_status = 1) then '部分还款'
				when (pl.src_type = 2 and pl.repay_status = 2) then '线上已还款'
				when (pl.src_type = 2 and pl.repay_status = 3) then '全部已还款'
				when (pl.src_type = 2 and pl.repay_status is null ) then '未还款'
			END AS repayStatus, pl.accountant_confirm_status AS financeConfirmStatus
				,pl.fact_amount_ext AS repaidAmount, pl.src_type AS srcType
				, CASE
				WHEN (pl.plan_status_ext = 0) THEN '还款中'
				WHEN (pl.plan_status_ext = 10) THEN '已结清'
				WHEN (pl.plan_status_ext = 20) THEN '已结清'
				WHEN (pl.plan_status_ext = 30) THEN '亏损结清'
				WHEN (pl.plan_status_ext = 31) THEN '坏账结清'
				WHEN (pl.plan_status_ext = 50) THEN '已申请展期'
				ELSE null
				END AS planStatusExt
			FROM tb_repayment_biz_plan_list_synch pl
			<if test="paymentPlatformCode!=null">
	        JOIN tb_tuandai_project_info as ttpi ON pl.business_id = ttpi.business_id
	        and ttpi.plate_type = #{paymentPlatformCode,jdbcType=INTEGER}
	        </if>	
		<where>
			1 = 1
			<if test="userId !=null  and userId != '' and needPermission == 1">
                and pl.orig_business_id in (
					select business_id from tb_sys_user_permission where page_type = 9 and user_id = #{userId}    	
                )
            </if>
			<if test="customer != null">
				<!-- AND b.customer_name = #{customer} -->
				AND pl.customer_name_ext like '${customer}%' 
			</if>
			<if test="businessId != null">
				AND pl.orig_business_id like  '${businessId}%'
			</if>
			<if test="accountantConfirmStatus != null">
				AND pl.accountant_confirm_status =
				#{accountantConfirmStatus}
			</if>
			<if test="areaId != null">
				AND pl.area_pid_ext = #{areaId}
			</if>
			<if test="companyId != null">
				AND pl.company_id_ext = #{companyId}
			</if>
			<if test="businessType != null ">
				AND pl.business_type_ext = #{businessType}
			</if>
			<if test="repayDate != null">
				AND DATE_FORMAT(pl.due_date,'%Y-%m-%d') = #{repayDate}
			</if>
			<if test="regDateStart != null ">
				AND pl.trade_date_ext &gt;= #{regDateStart}
			</if>
			<if test="regDateEnd != null ">
				AND pl.trade_date_ext &lt;= #{regDateEnd}
			</if>
			<if test="status != null ">
				AND pl.current_status = #{status}
			</if>
		</where>
		order by pl.due_date,pl.period
		limit ${(curPage-1)*pageSize} , ${pageSize}
	</select>

    <select id="queryFirstPeriodOverdueByBusinessId" resultType="java.lang.Integer">
    	SELECT
		    DATEDIFF(CURDATE(), tab.due_date) firstPeriodOverdue -- 首期逾期
		  FROM
		    (SELECT
		      t2.`due_date`
		    FROM
		      tb_basic_business t1,
		      tb_repayment_biz_plan_list t2
		    WHERE t1.`business_id` = t2.`orig_business_id`
		      AND t2.`current_status` = '逾期'
		      AND t2.`period` != 0
		      AND t2.`due_date` =
		      (SELECT
		        MIN(due_date)
		      FROM
		        tb_repayment_biz_plan_list
		      WHERE orig_business_id = t1.`business_id`)
		      AND t1.`business_id` = #{businessId,jdbcType=VARCHAR}
		      ORDER BY t2.`due_date`
		      LIMIT 1) tab
    </select>

    <select id="queryInterestOverdueByBusinessId" resultType="java.lang.Integer">
    	SELECT
		  DATEDIFF(CURDATE(), tab.due_date) interestOverdue -- 利息逾期
		FROM
		  (SELECT
		    t2.`due_date`
		  FROM
		    tb_basic_business t1,
		    tb_repayment_biz_plan_list t2 
		  WHERE t1.`business_id` = t2.`orig_business_id` 
		    AND t2.`current_status` = '逾期' 
		    AND t1.`business_id` = #{businessId,jdbcType=VARCHAR}
		    AND NOT EXISTS 
		    (SELECT 
		      1 
		    FROM
		      tb_repayment_biz_plan_list_detail d 
		    WHERE d.`plan_list_id` = t2.`plan_list_id`
		      AND d.`plan_item_type` = '10' 
		      AND d.`plan_amount` > 0) 
		  ORDER BY t2.`due_date` 
		  LIMIT 1) tab 
    </select>

    <select id="queryPrincipalOverdueByBusinessId" resultType="java.lang.Integer">
    	SELECT
		  DATEDIFF(CURDATE(), tab.due_date) principalOverdue -- 本金逾期
		FROM
		  (SELECT
		    t2.`due_date`
		  FROM
		    tb_basic_business t1,
		    tb_repayment_biz_plan_list t2
		  WHERE t1.`business_id` = t2.`orig_business_id`
		    AND t2.`current_status` = '逾期'
		    AND t1.`business_id` = #{businessId,jdbcType=VARCHAR}
		    AND EXISTS
		    (SELECT
		      1
		    FROM
		      tb_repayment_biz_plan_list_detail d
		    WHERE d.`plan_list_id` = t2.`plan_list_id`
		      AND d.`plan_item_type` = '10'
		      AND d.`plan_amount` > 0)
		  ORDER BY t2.`due_date`
		  LIMIT 1) tab
    </select>
    
	<select id="selectAutoRepayList" resultType="com.hongte.alms.base.entity.RepaymentBizPlanList">
     
	  select 
	     <include refid="Base_Column_List"/>
       from tb_repayment_biz_plan_list   
	  
	  where confirm_flag=1   <![CDATA[  and  due_date<=curdate()]]>     <![CDATA[ and    `current_status`  <>'已还款' ]]> and src_type=2 order by period 
	  
    </select>
    
    <select id="queryRepaymentPlanInfoByBusinessId" resultType="com.hongte.alms.base.dto.RepaymentPlanInfoDTO">
			  SELECT 
				  * 
				FROM
				  (SELECT 
				    rbpl.plan_list_id,
				    '计划还款' repayment,
				    rbpl.`after_id` afterId,
				    rbpl.period,
				    rbpl.`due_date` repaymentDate,
				    -- 应还本金总额
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 10 
				          THEN rbpld.`plan_amount` 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `principal`,
				    -- 应还利息总额
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 20 
				          THEN rbpld.plan_amount 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `accrual`,
				    -- 应还资产端分公司服务费总额
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 30 
				          THEN rbpld.plan_amount 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `serviceCharge`,
				    -- 应还资金端平台服务费
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 50 
				          THEN rbpld.plan_amount 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `platformCharge`,
				    IFNULL(rbpl.`overdue_days`, 0) overdueDays,
				    -- 应还线上滞纳金
				    (SELECT 
				      IFNULL(SUM(t2.plan_amount), 0) - IFNULL(SUM(t2.`derate_amount`), 0) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t2.fee_id = '2e646c87-5721-11e8-8a00-0242ac110002' 
				      AND t1.plan_list_id = rbpl.plan_list_id) onlineLateFee,
				    -- 应还线下滞纳金
				    (SELECT 
				      IFNULL(SUM(t2.plan_amount), 0) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t2.plan_item_type = 60 
				      AND t2.fee_id != '2e646c87-5721-11e8-8a00-0242ac110002' 
				      AND t1.plan_list_id = rbpl.plan_list_id) offlineLateFee,
				    -- 线下减免金额
				    (SELECT 
				      IFNULL(SUM(t2.derate_amount), 0) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t2.fee_id != '2e646c87-5721-11e8-8a00-0242ac110002' 
				      AND t2.plan_item_type = 60 
				      AND t1.plan_list_id = rbpl.plan_list_id) offlineDerateAmount,
				    -- 线上减免金额
				    (SELECT 
				      IFNULL(SUM(t2.derate_amount), 0) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t2.fee_id = '2e646c87-5721-11e8-8a00-0242ac110002' 
				      AND t1.plan_list_id = rbpl.plan_list_id) onlineDerateAmount,
				    (SELECT 
				      IFNULL(SUM(t2.plan_amount), 0) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t1.plan_list_id = rbpl.plan_list_id) amount,
				    (SELECT 
				      IFNULL(SUM(t2.plan_amount), 0) otherFee 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t1.plan_list_id = rbpl.plan_list_id 
				      AND t2.plan_item_type NOT IN (10, 20, 30, 50, 60)) otherFee,
				    0 surplus,
				    CASE
				      rbpl.`current_status` 
				      WHEN '已还款' 
				      THEN rbpl.`repay_flag` 
				      WHEN '还款中' 
				      THEN IFNULL(rbpl.repay_status, 0) 
				      WHEN '逾期' 
				      THEN IFNULL(rbpl.repay_status, - 1) 
				    END confirmFlag,
				    '' confirmFlagStr,
				    CASE
				      WHEN rbpl.orig_business_id = rbpl.business_id 
				      THEN 1 
				      ELSE 0 
				    END isOrig 
				  FROM
				    `tb_repayment_biz_plan_list` rbpl,
				    `tb_repayment_biz_plan_list_detail` rbpld 
				  WHERE rbpl.plan_list_id = rbpld.plan_list_id 
				    AND rbpl.orig_business_id = #{businessId,jdbcType=VARCHAR}  
				  GROUP BY rbpl.`plan_list_id` 
				  UNION
				  ALL 
				  SELECT 
				    rbpl.plan_list_id,
				    '实际还款' repayment,
				    rbpl.`after_id` afterId,
				    rbpl.period,
				    rbpl.`fact_repay_date` repaymentDate,
				    -- 实还本金总额
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 10 
				          THEN rbpld.`fact_amount` 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `principal`,
				    -- 实还利息总额
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 20 
				          THEN rbpld.fact_amount 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `accrual`,
				    -- 实还资产端分公司服务费总额
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 30 
				          THEN rbpld.fact_amount 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `serviceCharge`,
				    -- 实还资金端平台服务费
				    IFNULL(
				      SUM(
				        CASE
				          WHEN rbpld.plan_item_type = 50 
				          THEN rbpld.fact_amount 
				          ELSE 0 
				        END
				      ),
				      0
				    ) `platformCharge`,
				    IFNULL(rbpl.`overdue_days`, 0) overdueDays,
				    -- 实还线上滞纳金
				    (SELECT 
				      IFNULL(
				        SUM(
				          CASE
				            WHEN t2.plan_item_type = 60 
				            THEN t2.fact_amount 
				            ELSE 0 
				          END
				        ),
				        0
				      ) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t2.fee_id = '2e646c87-5721-11e8-8a00-0242ac110002' 
				      AND t1.plan_list_id = rbpl.plan_list_id) onlineLateFee,
				    -- 实还线下滞纳金
				    (SELECT 
				      IFNULL(
				        SUM(
				          CASE
				            WHEN t2.plan_item_type = 60 
				            THEN t2.fact_amount 
				            ELSE 0 
				          END
				        ),
				        0
				      ) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t2.fee_id != '2e646c87-5721-11e8-8a00-0242ac110002' 
				      AND t1.plan_list_id = rbpl.plan_list_id) offlineLateFee,
				    0 offlineDerateAmount,
				    0 onlineDerateAmount,
				    (SELECT 
				      IFNULL(SUM(t2.fact_amount), 0) 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t1.plan_list_id = rbpl.plan_list_id) amount,
				    (SELECT 
				      IFNULL(SUM(t2.fact_amount), 0) otherFee 
				    FROM
				      `tb_repayment_biz_plan_list` t1,
				      `tb_repayment_biz_plan_list_detail` t2 
				    WHERE t1.plan_list_id = t2.plan_list_id 
				      AND t1.plan_list_id = rbpl.plan_list_id 
				      AND t2.plan_item_type NOT IN (10, 20, 30, 50, 60)) otherFee,
				    (SELECT 
				      IFNULL(SUM(t.over_repay_money), 0) over_repay_money_1 
				    FROM
				      `tb_accountant_over_repay_log` t 
				      LEFT JOIN tb_repayment_confirm_log rcl 
				        ON rcl.surplus_ref_id = t.log_id 
				        
				    WHERE t.freeze_status != 1 
				      AND rcl.is_cancelled = 0 
				      AND t.money_type = 1 
				      AND t.business_id = #{businessId,jdbcType=VARCHAR}  
				      AND t.business_after_id = rbpl.after_id) - 
				    (SELECT 
				      IFNULL(SUM(t.over_repay_money), 0) over_repay_money_1 
				    FROM
				      `tb_accountant_over_repay_log` t 
				      LEFT JOIN tb_repayment_confirm_log rcl 
				        ON rcl.surplus_ref_id = t.log_id 
				    WHERE t.freeze_status != 1 
				      AND rcl.is_cancelled = 0 
				      AND t.money_type = 0 
				      AND rcl.surplus_use_ref_id is null 
				      AND t.business_id = #{businessId,jdbcType=VARCHAR}  
				      AND t.business_after_id = rbpl.after_id) surplus,
				    CASE
				      rbpl.`current_status` 
				      WHEN '已还款' 
				      THEN rbpl.`repay_flag` 
				      WHEN '还款中' 
				      THEN IFNULL(rbpl.repay_status, 0) 
				      WHEN '逾期' 
				      THEN IFNULL(rbpl.repay_status, - 1) 
				    END confirmFlag,
				    rbpl.remark confirmFlagStr,
				    CASE
				      WHEN rbpl.orig_business_id = rbpl.business_id 
				      THEN 1 
				      ELSE 0 
				    END isOrig 
				  FROM
				    `tb_repayment_biz_plan_list` rbpl,
				    `tb_repayment_biz_plan_list_detail` rbpld 
				  WHERE rbpl.plan_list_id = rbpld.plan_list_id 
				    AND rbpl.orig_business_id = #{businessId,jdbcType=VARCHAR}  
				  GROUP BY rbpl.`plan_list_id` 
				  ) tab 
				ORDER BY tab.period,
				  tab.afterId,
				  tab.repayment DESC,
				  tab.repaymentDate  
    </select>
    
    <select id="queryPlanRepaymentProjInfoByPlanListId" resultType="com.hongte.alms.base.dto.RepaymentProjInfoDTO">
		SELECT 
		  rppl.`proj_plan_list_id` projPlanListId,
		  '计划还款' repayment,
		  rppl.`after_id` afterId,
		  rppl.`due_date` repaymentDate,
		  rpp.`project_id`,
		  tpi.`real_name`,
		  -- 应还本金总额
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 10 
		        THEN rppld.proj_plan_amount 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `principal`,
		  -- 应还利息总额
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 20 
		        THEN rppld.proj_plan_amount 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `accrual`,
		  -- 应还资产端分公司服务费总额
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 30 
		        THEN rppld.proj_plan_amount 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `serviceCharge`,
		  -- 应还资金端平台服务费
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 50 
		        THEN rppld.proj_plan_amount 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `platformCharge`,
		  IFNULL(rppl.`overdue_days`, 0) overdueDays,
		  -- 应还线上滞纳金
		  (SELECT 
		    IFNULL(SUM(t2.proj_plan_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t2.fee_id = '2e646c87-5721-11e8-8a00-0242ac110002' 
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) onlineLateFee,
		  -- 应还线下滞纳金
		  (SELECT 
		    IFNULL(SUM(t2.proj_plan_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t2.fee_id != '2e646c87-5721-11e8-8a00-0242ac110002' 
		    AND t2.plan_item_type = 60
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) offlineLateFee,
          -- 线上减免金额
		  (SELECT 
		    IFNULL(SUM(t2.derate_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t2.fee_id = '2e646c87-5721-11e8-8a00-0242ac110002' 
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) onlineDerateAmount,
		    -- 线下减免金额
		  (SELECT 
		    IFNULL(SUM(t2.derate_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t2.fee_id != '2e646c87-5721-11e8-8a00-0242ac110002' 
		    AND t2.plan_item_type = 60
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) offlineDerateAmount,
		  (SELECT 
		    IFNULL(SUM(t2.proj_plan_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) amount,
		  (SELECT 
			    IFNULL(SUM(t2.proj_plan_amount), 0) otherFee 
			  FROM
			    `tb_repayment_proj_plan_list` t1,
			    `tb_repayment_proj_plan_list_detail` t2 
			  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
			    AND t1.proj_plan_list_id = rppl.proj_plan_list_id
			    AND t2.plan_item_type NOT IN (10, 20, 30, 50, 60)) otherFee,
		  CASE
		    rppl.`current_status` 
		    WHEN '已还款' 
		    THEN rppl.`repay_flag` 
		    WHEN '还款中' 
		    THEN IFNULL(rppl.repay_status, 0)
		    WHEN '逾期'
		    THEN IFNULL(rppl.repay_status, -1)
		  END confirmFlag,
		  '' confirmFlagStr
		FROM
		  `tb_repayment_proj_plan_list` rppl,
		  `tb_repayment_proj_plan_list_detail` rppld,
		  `tb_repayment_proj_plan` rpp,
		  `tb_tuandai_project_info` tpi 
		WHERE rppl.proj_plan_list_id = rppld.proj_plan_list_id 
		  AND rppl.`proj_plan_id` = rpp.`proj_plan_id` 
		  AND rpp.`project_id` = tpi.`project_id` 
		  AND rppl.`plan_list_id` = #{planListId,jdbcType=VARCHAR} 
		GROUP BY rppl.`proj_plan_list_id`
    </select>
    
    <select id="queryActualRepaymentProjInfoByPlanListId" resultType="com.hongte.alms.base.dto.RepaymentProjInfoDTO">
		SELECT 
		  rppl.`proj_plan_list_id` projPlanListId,
		  '实际还款' repayment,
		  rppl.`after_id` afterId,
		  rppl.`fact_repay_date` repaymentDate,
		  rpp.`project_id`,
		  tpi.`real_name`,
		  -- 实还本金总额
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 10 
		        THEN rppld.`proj_fact_amount` 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `principal`,
		  -- 实还利息总额
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 20 
		        THEN rppld.proj_fact_amount 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `accrual`,
		  -- 实还资产端分公司服务费总额
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 30 
		        THEN rppld.proj_fact_amount 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `serviceCharge`,
		  -- 实还资金端平台服务费
		  IFNULL(
		    SUM(
		      CASE
		        WHEN rppld.plan_item_type = 50 
		        THEN rppld.proj_fact_amount 
		        ELSE 0 
		      END
		    ),
		    0
		  ) `platformCharge`,
		  IFNULL(rppl.`overdue_days`, 0) overdueDays,
		  -- 实还线上滞纳金
		  (SELECT 
		    IFNULL(SUM(t2.proj_fact_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t2.fee_id = '2e646c87-5721-11e8-8a00-0242ac110002' 
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) onlineLateFee,
		  -- 实还线下滞纳金
		  (SELECT 
		    IFNULL(SUM(t2.proj_fact_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t2.fee_id != '2e646c87-5721-11e8-8a00-0242ac110002' 
		    AND t2.plan_item_type = 60
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) offlineLateFee,
		  (SELECT 
		    IFNULL(SUM(t2.proj_fact_amount), 0) 
		  FROM
		    `tb_repayment_proj_plan_list` t1,
		    `tb_repayment_proj_plan_list_detail` t2 
		  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    AND t1.proj_plan_list_id = rppl.proj_plan_list_id) amount,
		  (SELECT 
			    IFNULL(SUM(t2.proj_fact_amount), 0) otherFee 
			  FROM
			    `tb_repayment_proj_plan_list` t1,
			    `tb_repayment_proj_plan_list_detail` t2 
			  WHERE t1.proj_plan_list_id = t2.proj_plan_list_id 
		    	AND t1.proj_plan_list_id = rppl.proj_plan_list_id 
			    AND t2.plan_item_type NOT IN (10, 20, 30, 50, 60)) otherFee,
		  CASE
		    rppl.`current_status` 
		    WHEN '已还款' 
		    THEN rppl.`repay_flag` 
		    WHEN '还款中' 
		    THEN IFNULL(rppl.repay_status, 0)
		    WHEN '逾期'
		    THEN IFNULL(rppl.repay_status, -1)
		  END confirmFlag,
		  rppl.remark confirmFlagStr
		FROM
		  `tb_repayment_proj_plan_list` rppl,
		  `tb_repayment_proj_plan_list_detail` rppld,
		  `tb_repayment_proj_plan` rpp,
		  `tb_tuandai_project_info` tpi 
		WHERE rppl.proj_plan_list_id = rppld.proj_plan_list_id 
		  AND rppl.`proj_plan_id` = rpp.`proj_plan_id` 
		  AND rpp.`project_id` = tpi.`project_id` 
		  AND rppl.`plan_list_id` = #{planListId,jdbcType=VARCHAR} 
		GROUP BY rppl.`proj_plan_list_id`
    </select>
    
    <select id="caluBizPlanListUnpaid" resultType="java.math.BigDecimal">
	    SELECT
			( IFNULL( SUM( proj_plan_amount ), 0 ) - IFNULL( SUM( derate_amount ), 0 ) ) - ( IFNULL( SUM( proj_fact_amount ), 0 ) ) 
		FROM
			tb_repayment_proj_plan_list_detail 
		WHERE
			plan_list_id = #{planListId}
    </select>
    <select id="caluBizPlanListFactAmount" resultType="java.math.BigDecimal">
	    SELECT
			IFNULL( SUM( proj_fact_amount ), 0 ) 
		FROM
			tb_repayment_proj_plan_list_detail 
		WHERE
			plan_list_id = #{planListId}
    </select>
    <select id="caluBizPlanListPlanAmount" resultType="java.math.BigDecimal">
	    SELECT
			( IFNULL( SUM( proj_plan_amount ), 0 ) - IFNULL( SUM( derate_amount ), 0 ) ) 
		FROM
			tb_repayment_proj_plan_list_detail 
		WHERE
			plan_list_id = #{planListId}
    </select>
    <select id="listConfirmWithhold" resultType="com.hongte.alms.base.vo.finance.ConfirmWithholdListVO">
    SELECT
		after_id AS afterId,
		due_date AS dueDate,
	IF
		( confirm_flag = 1, '已确认', '待确认' ) AS `status`,
		total_borrow_amount AS total,
		IFNULL(
		( SELECT sum( IFNULL( plan_amount, 0 ) ) FROM tb_repayment_biz_plan_list_detail WHERE plan_list_id = bpl.plan_list_id AND plan_item_type = 10 ),
		0 
		) AS item10,
		IFNULL(
		( SELECT sum( IFNULL( plan_amount, 0 ) ) FROM tb_repayment_biz_plan_list_detail WHERE plan_list_id = bpl.plan_list_id AND plan_item_type = 20 ),
		0 
		) AS item20,
		IFNULL(
		( SELECT sum( IFNULL( plan_amount, 0 ) ) FROM tb_repayment_biz_plan_list_detail WHERE plan_list_id = bpl.plan_list_id AND plan_item_type = 30 ),
		0 
		) AS item30,
		IFNULL(
		( SELECT sum( IFNULL( plan_amount, 0 ) ) FROM tb_repayment_biz_plan_list_detail WHERE plan_list_id = bpl.plan_list_id AND plan_item_type = 50 ),
		0 
		) AS item50 
	FROM
		tb_repayment_biz_plan_list bpl 
	WHERE
		bpl.business_id = #{businessId} 
	ORDER BY
		bpl.after_id
    </select>
    
    
        <select id="getPlanListForCalLateFee" resultType="com.hongte.alms.base.entity.RepaymentBizPlanList">
	       SELECT plan_list_id AS planListId,plan_id AS planId,business_id AS businessId,orig_business_id AS origBusinessId,period,after_id AS afterId,due_date AS dueDate,total_borrow_amount AS totalBorrowAmount,overdue_amount AS overdueAmount,derate_amount AS derateAmount,overdue_days AS overdueDays,current_status AS currentStatus,current_sub_status AS currentSubStatus,repay_status AS repayStatus,repay_flag AS repayFlag,fact_repay_date AS factRepayDate,finance_comfirm_date AS financeComfirmDate,finance_confirm_user AS financeConfirmUser,finance_confirm_user_name AS financeConfirmUserName,confirm_flag AS confirmFlag,auto_withholding_confirmed_date AS autoWithholdingConfirmedDate,auto_withholding_confirmed_user AS autoWithholdingConfirmedUser,auto_withholding_confirmed_user_name AS autoWithholdingConfirmedUserName,accountant_confirm_status AS accountantConfirmStatus,accountant_confirm_user AS accountantConfirmUser,accountant_confirm_user_name AS accountantConfirmUserName,accountant_confirm_date AS accountantConfirmDate,remark,create_time AS createTime,src_type AS srcType,create_user AS `createUser`,update_time AS updateTime,update_user AS updateUser
FROM tb_repayment_biz_plan_list
WHERE (src_type = 2 AND current_status <![CDATA[ <>  ]]> '已还款' AND (current_sub_status <![CDATA[ <>  ]]> '还款待确认' OR current_sub_status IS NULL) 
AND due_date <![CDATA[ < now() ]]> 
AND plan_id = #{planListId}) 
    
    </select>
    
    <select id="queryTransferOfLitigationData" resultType="com.hongte.alms.base.entity.RepaymentBizPlanList">
    	SELECT 
		  <include refid="TableName_Column_List"/> 
		FROM
		  tb_repayment_biz_plan_list planList 
		WHERE planList.`overdue_days` >= #{overDueDays,jdbcType=INTEGER} 
		  AND planList.current_status IN ("还款中", "逾期") 
		  AND IFNULL(planList.`repay_status`, 0) NOT IN (2, 3) 
		  AND NOT EXISTS 
		  (SELECT 
		    1 
		  FROM
		    `tb_collection_status` t2 
		  WHERE t2.`collection_status` IN (100, 200) 
		    AND t2.`original_business_id` = planList.`orig_business_id`)
		<if test = "origBusinessId != null and origBusinessId !=''">
		  AND planList.`orig_business_id` = #{origBusinessId,jdbcType=VARCHAR}
		</if>
    </select>
    
 
</mapper>
