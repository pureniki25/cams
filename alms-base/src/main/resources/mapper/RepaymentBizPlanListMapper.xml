<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hongte.alms.base.mapper.RepaymentBizPlanListMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.hongte.alms.base.entity.RepaymentBizPlanList">
        <id column="plan_list_id" property="planListId" />
        <result column="plan_id" property="planId" />
        <result column="business_id" property="businessId" />
        <result column="orig_business_id" property="origBusinessId" />
        <result column="period" property="period" />
        <result column="after_id" property="afterId" />
        <result column="due_date" property="dueDate" />
        <result column="total_borrow_amount" property="totalBorrowAmount" />
        <result column="overdue_amount" property="overdueAmount" />
        <result column="overdue_days" property="overdueDays" />
        <result column="current_status" property="currentStatus" />
        <result column="current_sub_status" property="currentSubStatus" />
        <result column="repay_flag" property="repayFlag" />
        <result column="fact_repay_date" property="factRepayDate" />
        <result column="finance_comfirm_date" property="financeComfirmDate" />
        <result column="finance_confirm_user" property="financeConfirmUser" />
        <result column="finance_confirm_user_name" property="financeConfirmUserName" />
        <result column="confirm_flag" property="confirmFlag" />
        <result column="auto_withholding_confirmed_date" property="autoWithholdingConfirmedDate" />
        <result column="auto_withholding_confirmed_user" property="autoWithholdingConfirmedUser" />
        <result column="auto_withholding_confirmed_user_name" property="autoWithholdingConfirmedUserName" />
        <result column="accountant_confirm_status" property="accountantConfirmStatus" />
        <result column="accountant_confirm_user" property="accountantConfirmUser" />
        <result column="accountant_confirm_user_name" property="accountantConfirmUserName" />
        <result column="accountant_confirm_date" property="accountantConfirmDate" />
        <result column="remark" property="remark" />
        <result column="active" property="active" />
        <result column="create_time" property="createTime" />
        <result column="src_type" property="srcType" />
        <result column="create_user" property="createUser" />
        <result column="update_time" property="updateTime" />
        <result column="update_user" property="updateUser" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        plan_list_id AS planListId, plan_id AS planId, business_id AS businessId, orig_business_id AS origBusinessId, period, after_id AS afterId, due_date AS dueDate, total_borrow_amount AS totalBorrowAmount, overdue_amount AS overdueAmount, overdue_days AS overdueDays, current_status AS currentStatus, current_sub_status AS currentSubStatus, repay_flag AS repayFlag, fact_repay_date AS factRepayDate, finance_comfirm_date AS financeComfirmDate, finance_confirm_user AS financeConfirmUser, finance_confirm_user_name AS financeConfirmUserName, confirm_flag AS confirmFlag, auto_withholding_confirmed_date AS autoWithholdingConfirmedDate, auto_withholding_confirmed_user AS autoWithholdingConfirmedUser, auto_withholding_confirmed_user_name AS autoWithholdingConfirmedUserName, accountant_confirm_status AS accountantConfirmStatus, accountant_confirm_user AS accountantConfirmUser, accountant_confirm_user_name AS accountantConfirmUserName, accountant_confirm_date AS accountantConfirmDate, remark, active, create_time AS createTime, src_type AS srcType, create_user AS createUser, update_time AS updateTime, update_user AS updateUser
    </sql>

    <!-- 通用查询结果列 -->
    <sql id="TableName_Column_List">
        planList.plan_list_id AS planListId, planList.plan_id AS planId, planList.business_id AS businessId, planList.period as period, planList.after_id AS afterId, planList.due_date AS dueDate, planList.total_borrow_amount AS totalBorrowAmount, planList.overdue_amount AS overdueAmount, planList.overdue_days AS overdueDays, planList.current_status AS currentStatus, planList.repay_flag AS repayFlag, planList.fact_repay_date AS factRepayDate, planList.finance_comfirm_date AS financeComfirmDate, planList.finance_confirm_user AS financeConfirmUser, planList.finance_confirm_user_name AS financeConfirmUserName, planList.confirm_flag AS confirmFlag, planList.auto_withholding_confirmed_date AS autoWithholdingConfirmedDate, planList.auto_withholding_confirmed_user AS autoWithholdingConfirmedUser, planList.accountant_confirm_status AS accountantConfirmStatus, planList.accountant_confirm_user AS accountantConfirmUser, planList.accountant_confirm_user_name AS accountantConfirmUserName, planList.accountant_confirm_date AS accountantConfirmDate, planList.remark AS  remark, planList.create_time AS createTime, planList.create_user AS createUser, planList.update_time AS updateTime, planList.update_user AS updateUser
    </sql>

    <!-- 选择需要 自动移交的一般业务还款计划列表(包括展期业务) -->
    <select id="selectNeedSetColInfoNormalBizPlansBycomId"
            resultType="com.hongte.alms.base.entity.RepaymentBizPlanList">
        SELECT
        <include refid="TableName_Column_List"/>

        FROM tb_repayment_biz_plan_list planList
        LEFT JOIN tb_repayment_biz_plan plan ON plan.plan_id = planList.plan_id
        LEFT JOIN tb_basic_business business ON plan.original_business_id = business.business_id
        LEFT JOIN tb_basic_business_type type on type.business_type_id=business.business_type

        WHERE
        <![CDATA[ TO_DAYS(NOW()) - TO_DAYS(planList.due_date) > #{overDueDays}  ]]>
        <if test = "companyId != null and companyId!='' ">
            and business.company_id = #{companyId}
        </if>
        
         <if test = "businessType != null and businessType!='' and businessType!=0">
            and type.business_type_id = #{businessType}
        </if>
        AND planList.current_status IN ("还款中","逾期")
        AND (
        SELECT COUNT(1) as num1  FROM tb_collection_status  cStatus
        WHERE (cStatus.collection_status  = 100 OR cStatus.collection_status = 150)
        AND cStatus.business_id = business.business_id
        ) = 0
        AND (
        SELECT COUNT(1) as num2  FROM tb_collection_status  cStatus
        WHERE cStatus.collection_status = #{colStatus}
        AND cStatus.business_id = business.business_id
        AND cStatus.crp_id = planList.plan_list_id
        ) = 0


    </select>
    
    <select id="queryRepaymentBizPlanListByConditions" resultType="java.lang.String">
   		SELECT b.plan_list_id 
   		  FROM `tb_repayment_biz_plan` a, `tb_repayment_biz_plan_list` b
		WHERE a.`plan_id` = b.`plan_id`
		  AND a.`original_business_id` = #{businessId,jdbcType=VARCHAR}
		  AND b.`after_id` = #{afterId,jdbcType=VARCHAR}
    </select>
    <!--AND cStatus.crp_id = planList.plan_list_id  -->

   <!-- &lt;!&ndash; 需要自动移交的展期业务的还款计划 &ndash;&gt;
    <select id="selectNeedSetColInfoRenewBizPlansBycomId" resultType="com.hongte.alms.base.entity.RepaymentBizPlanList">

    SELECT <include refid="TableName_Column_List"/>

    FROM tb_repayment_biz_plan_list planList
    LEFT JOIN tb_repayment_biz_plan plan ON plan.plan_id = planList.plan_id
    LEFT JOIN tb_renewal_business rewBiz ON plan.business_id = rewBiz.renewal_business_id
    LEFT JOIN tb_basic_business business ON rewBiz.original_business_id = business.business_id


    WHERE
    <![CDATA[ TO_DAYS(NOW()) - TO_DAYS(planList.due_date) > #{overDueDays}  ]]>
        <if test = "companyId != null and companyId!='' ">
            and business.company_id = #{companyId}
        </if>
    AND planList.current_status IN ("还款中","逾期")
    AND (
        SELECT COUNT(1) as num  FROM tb_collection_status  cStatus
        WHERE cStatus.collection_status =100
        AND cStatus.business_id = rewBiz.renewal_business_id
        ) = 0
    AND (
        SELECT COUNT(1) as num  FROM tb_collection_status  cStatus
        WHERE cStatus.collection_status = #{colStatus}
        AND cStatus.business_id = rewBiz.renewal_business_id
        AND cStatus.crp_id = planList.plan_list_id
        ) = 0

    </select>-->
    <!-- AND cStatus.crp_id = planList.plan_list_id -->

    <select id="conutFinanceManagerList" resultType="int"
		parameterType="com.hongte.alms.base.dto.FinanceManagerListReq">
		SELECT
			count(1)
		FROM
			tb_repayment_biz_plan_list pl
		LEFT JOIN
			tb_basic_business b ON b.business_id = pl.business_id
		<where>
			1 = 1
			<if test="customer != null">
				AND b.customer_name = #{customer}
			</if>
			<if test="businessId != null">
				AND pl.business_id = #{businessId}
			</if>
			<if test="accountantConfirmStatus != null">
				AND pl.accountant_confirm_status =
				#{accountantConfirmStatus}
			</if>
			<if test="companyId != null">
				AND b.company_name = #{companyId}
			</if>
			<if test="businessType != null ">
				AND b.business_type = #{businessType}
			</if>
			<if test="repayDate != null">
				AND pl.due_date = #{repayDate}
			</if>
			<if test="regDateStart != null ">
				AND pl.fact_repay_date &gt;= #{regDateStart}
			</if>
			<if test="regDateEnd != null ">
				AND pl.fact_repay_date &lt;= #{regDateEnd}
			</if>
			<if test="status != null ">
				AND pl.current_status = #{status}
			</if>
		</where>

	</select>

	<select id="selectFinanceMangeList"
		resultType="com.hongte.alms.base.vo.module.FinanceManagerListVO"
		parameterType="com.hongte.alms.base.dto.FinanceManagerListReq">
		SELECT
			pl.plan_list_id as planListId,
			pl.business_id as businessId,
			pl.after_id as afterId ,
			b.company_name as dept,
			b.operator_name as operator,
			b.customer_name as customer,
			b.business_ctype as businessType ,
			pl.due_date as planRepayDate ,
			pl.fact_repay_date as factRepayDate,
			pl.total_borrow_amount as planRepayAmount,
			pl.current_status as status ,
			pl.accountant_confirm_status as financeConfirmStatus
		FROM
			tb_repayment_biz_plan_list pl
		LEFT JOIN
			tb_basic_business b ON b.business_id = pl.business_id
		<where>
			1 = 1
			<if test="customer != null">
				AND b.customer_name = #{customer}
			</if>
			<if test="businessId != null">
				AND pl.business_id = #{businessId}
			</if>
			<if test="accountantConfirmStatus != null">
				AND pl.accountant_confirm_status =
				#{accountantConfirmStatus}
			</if>
			<if test="companyId != null">
				AND b.company_name = #{companyId}
			</if>
			<if test="businessType != null ">
				AND b.business_type = #{businessType}
			</if>
			<if test="repayDate != null">
				AND pl.due_date = #{repayDate}
			</if>
			<if test="regDateStart != null ">
				AND pl.fact_repay_date &gt;= #{regDateStart}
			</if>
			<if test="regDateEnd != null ">
				AND pl.fact_repay_date &lt;= #{regDateEnd}
			</if>
			<if test="status != null ">
				AND pl.current_status = #{status}
			</if>
		</where>
		limit ${(curPage-1)*pageSize} , ${pageSize}
	</select>
</mapper>
