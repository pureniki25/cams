<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hongte.alms.base.mapper.ExpenseSettleMapper">
	<select id="listLackFee" resultType="com.hongte.alms.base.vo.module.ExpenseSettleLackFeeVO">
		SELECT 
		    lateFee, servicecharge, period
		FROM
		    (SELECT 
		        (SELECT 
		                    IFNULL(SUM(IFNULL(plan_amount, 0) - IFNULL(fact_amount, 0)), 0)
		                FROM
		                    tb_repayment_biz_plan_list_detail
		                WHERE
		                    plan_list_id = a.plan_list_id
		                        AND plan_item_name = '滞纳金') AS lateFee,
		            (SELECT 
		                    IFNULL(SUM(IFNULL(plan_amount, 0) - IFNULL(fact_amount, 0)), 0)
		                FROM
		                    tb_repayment_biz_plan_list_detail
		                WHERE
		                    plan_list_id = a.plan_list_id
		                        AND plan_item_name LIKE '%服务费%') AS servicecharge,
		            a.after_id as period
		    FROM
		        tb_repayment_biz_plan_list a
		    WHERE
		        a.business_id = #{businessId} ) tmp
		WHERE
		    (tmp.lateFee != 0
		        || tmp.serviceCharge != 0);
	</select>
</mapper>
