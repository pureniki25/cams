<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hongte.alms.base.process.mapper.ProcessLogMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.hongte.alms.base.process.entity.ProcessLog">
        <id column="process_log_id" property="processLogId" />
        <result column="process_id" property="processId" />
        <result column="process_name" property="processName" />
        <result column="type_step_id" property="typeStepId" />
        <result column="type_id" property="typeId" />
        <result column="step_name" property="stepName" />
        <result column="approve_user_id" property="approveUserId" />
        <result column="current_step" property="currentStep" />
        <result column="is_pass" property="isPass" />
        <result column="remark" property="remark" />
        <result column="action_desc" property="actionDesc" />
        <result column="next_step" property="nextStep" />
        <result column="back_step" property="backStep" />
        <result column="is_direct_back" property="isDirectBack" />
        <result column="is_send_from_start" property="isSendFromStart" />
        <result column="create_user" property="createUser" />
        <result column="create_time" property="createTime" />
        <result column="copy_send_info" property="copySendInfo" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        process_log_id AS processLogId, process_id AS processId, process_name AS processName, type_step_id AS typeStepId, type_id AS typeId, step_name AS stepName, approve_user_id AS approveUserId, current_step AS currentStep, is_pass AS isPass, remark, action_desc AS actionDesc, next_step AS nextStep, back_step AS backStep, is_direct_back AS isDirectBack, is_send_from_start AS isSendFromStart, create_user AS createUser, create_time AS createTime, copy_send_info AS copySendInfo
    </sql>


    <select id="getCurrentRuningProcessLog" resultType="com.hongte.alms.base.process.entity.ProcessLog">
        set @num := 0, @partitionByKey := '';

        select a.* from (
        SELECT
        case when @partitionByKey = l.current_step
        then @num:=@num+1
        else @num:=1
        end rownum,
        @partitionByKey:=l.current_step partitionByKey ,
        l.*
        FROM tb_process_log l
        left join tb_process p on l.process_id=p.process_id
        where l.process_id=#{process_id}
        and   ((p.status=0 and  p.current_step>l.current_step) or (p.status!=0) )
        and l.current_step is not null
        order by l.current_step,l.create_time desc)a
        where a.rownum=1
    </select>
    <select id="getProcessWorkLogList" resultType="java.util.Map">
        <if test="process_id != null and process_id != '' "  >
            set @num := 0, @partitionByKey := '';

            select t.step_name,t.step,
            r.is_pass,r.remark,
            case when p.status=0 and p.current_step=t.step then p.approve_user_id else	 r.approve_user_id end as approve_user_id,/*把待审核节点也合并到审核日志中，方便展示 */
            case when p.status=0 and p.current_step=t.step then  ifnull(pu.user_name,p.approve_user_id) else ifnull(u.user_name,r.approve_user_id) end as approve_user_name,
            r.create_time as approve_user_time,
            p.status,
            p.current_step

            from tb_process_type_step t
            left join (
            select a.* from (
            SELECT
            case when @partitionByKey = l.current_step
            then @num:=@num+1
            else @num:=1
            end rownum,
            @partitionByKey:=l.current_step partitionByKey ,
            l.*
            FROM tb_process_log l
            left join tb_process p on l.process_id=p.process_id
            where l.process_id=#{process_id}
            and   ((p.status=0 and  p.current_step>l.current_step) or (p.status!=0) )
            and l.current_step is not null
            order by l.current_step,l.create_time desc)a
            where a.rownum=1
            )r on  t.step=r.current_step
            left join tb_user u on  r.approve_user_id=u.user_id
            left join tb_process p on t.type_id=p.process_typeid
            left join tb_user pu on p.approve_user_id=pu.user_id
            where p.process_id=#{process_id}
            order by t.step;
        </if>
        /* 如果process_id为空，则使用流程类型，返回节点信息 */
        <if test="process_id == null or process_id == '' "  >
            select t.step_name,t.step
            from tb_process_type_step t
            where t.type_id=#{typeID}
            order by t.step
        </if>
    </select>

</mapper>
